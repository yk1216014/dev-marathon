name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # 1. Stagingへのデプロイ
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
              echo "--- Deploying to Staging ---"
              # ステージング環境ユーザー名はSecretsなどからとるか、kento_yokoyama固定か
              # ここでは kento_yokoyama とする
              cd /app/kento_yokoyama
              git fetch origin
              git reset --hard origin/main
              bash deploy.sh kento_yokoyama

  # 2. Cypressテストの実行 (Stagingに対して)
  run-e2e-tests:
    needs: deploy-staging # Stagingデプロイ後に実行
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install Dependencies
        run: |
          cd src/node
          npm install
          npm install cypress --save-dev

      - name: Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: .
          # テスト対象のBaseURLをステージングURLに上書き
          config: baseUrl=http://dev.marathon.rplearn.net/kento_yokoyama
          # specファイルの場所を指定
          spec: test/cypress/test.cy.js
          
      # テスト失敗時のスクリーンショットなどをアップロード
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

  # 3. Productionへのデプロイ
  deploy-production:
    needs: run-e2e-tests # テスト成功後に実行
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "--- Deploying to Production ---"
            cd /app/kento_yokoyama
            git fetch origin
            git reset --hard origin/main
            bash deploy.sh kento_yokoyama
