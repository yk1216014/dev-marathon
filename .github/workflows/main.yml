name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # 1. Stagingへのデプロイ (Zip転送)
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ソースコードをzipに圧縮
      - name: Create Zip Archive
        run: zip -r src.zip src/

      # Stagingサーバーへ転送 (src.zip と deploy.sh)
      - name: Transfer files to Staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "src.zip,deploy.sh"
          target: "/app/kento_yokoyama/"

      # サーバー上で解凍＆デプロイ実行
      - name: Execute Deploy Script on Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "--- Executing Staging Deployment ---"
            chmod +x /app/kento_yokoyama/deploy.sh
            bash /app/kento_yokoyama/deploy.sh kento_yokoyama

  # 2. Cypressテストの実行 (リモートのテストコードを使用)
  run-e2e-tests:
    needs: deploy-staging
    runs-on: ubuntu-latest
  # 2. Cypressテストの実行 (Stagingサーバー上で実行)
  run-e2e-tests:
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - name: Execute Cypress on Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 300s # テストが長引く場合に備えて少し長めに
          script: |
            echo "--- Starting Remote Cypress Test ---"
            cd /ci
            
            # 念のためファイルがあるか確認 (絶対パスで確実に見る)
            ls -l /ci/cypress/e2e/kento_yokoyama.cy.js
            
            # 手順書に従い、/ci に移動した状態で spec を指定
            npx cypress run --browser chrome --spec cypress/e2e/kento_yokoyama.cy.js

  # 3. Productionへのデプロイ (Zip転送)
  deploy-production:
    needs: run-e2e-tests
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Zip Archive
        run: zip -r src.zip src/

      # Productionサーバーへ転送
      - name: Transfer files to Production
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          source: "src.zip,deploy.sh"
          target: "/app/kento_yokoyama/"

      - name: Execute Deploy Script on Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          script: |
            echo "--- Executing Production Deployment ---"
            chmod +x /app/kento_yokoyama/deploy.sh
            bash /app/kento_yokoyama/deploy.sh kento_yokoyama
