# Staging環境デプロイ対応の修正報告書

## 1. 概要
ローカル環境（Docker）で開発したアプリケーションをStaging環境（AWS/Nginx + Node.js）へデプロイした際、画面が表示されない、API通信が失敗する等の問題が発生しました。
これに対し、ローカル環境とStaging環境の両方で、コードの書き換えなし（ワンソース）で動作するようにアプリケーションの改修を行いました。

---

## 2. 修正内容詳細

### ① フロントエンド設定の自動化 (config.js)

#### 修正前
APIの接続先URLがローカル環境用の `http://localhost:5465` にハードコーディングされていました。

#### 修正後
ブラウザのURL（`window.location`）を読み取り、実行環境を自動判別するロジックを追加しました。

*   **ローカルの場合**: `localhost` と判定し、`http://localhost:5465` を使用。
*   **Stagingの場合**: URLパスからユーザー名を抽出し、`/api_{username}` というStaging環境特有のURLプレフィックスを生成。

#### 修正の理由・目的
手順書では「デプロイのたびに手動で書き換える」指示がありましたが、作業ミス（記述ミスや戻し忘れ）の温床となるため、コード側で環境差分を吸収し、手作業をゼロにすることを目的としました。

---

### ② データベース接続設定の環境変数対応 (index.js)

#### 修正前
DB接続情報（ホスト名、ユーザー、パスワード）がローカルの `docker-compose` 用設定に固定されていました。

#### 修正後
環境変数 `DB_HOST` の値を確認し、接続情報を切り替えるロジックを実装しました。

*   **Docker環境**: ホスト名 `db` を検知し、開発用クレデンシャルを使用。
*   **Staging環境**: デフォルト（`localhost`）の場合、Stagingサーバー用のアカウント情報（手順書指定のもの）を自動選択。

#### 修正の理由・目的
フロントエンド同様、環境ごとの設定ファイルの書き換え作業を排除し、安全かつスムーズなデプロイを実現するためです。

---

### ③ 静的ファイル参照パスの修正 (index.js)

#### 修正前
HTMLやCSSを配信する際、ファイルパスを `path.join(__dirname, "../web")` と指定していました。

#### 修正後
#### 修正後
ファイルパスを `path.join(__dirname, "../web")` に統一しました。

#### 修正の理由・目的
`src/node` (バックエンド) と `src/web` (フロントエンド) が並列のディレクトリ構成になっているため、バックエンドから見て一つ上の階層にある `web` フォルダを参照するのが正しい構造です。
以前存在した `src/node/web` は空の不要フォルダであり、これが誤解を招く原因だったため、コード側も正しいディレクトリ (`../web`) を見るように修正し、不要なフォルダは削除しました。

---

### ④ APIルーティングのプレフィックス対応 (index.js)

#### 修正前
APIのエンドポイントが `/customers` などのルートパスで定義されていました。

#### 修正後
すべてのAPI定義を `apiRouter` にまとめ、以下の2通りのパスで待ち受けるように変更しました。
1.  `/` （ローカル環境用）
2.  `/api_*` （Staging環境用。例：`/api_kento_yokoyama/customers`）

```javascript
app.use("/", apiRouter);
app.use(/\/api_[^\/]+/, apiRouter);
```

#### 修正の理由・目的
Staging環境のNginx（リバースプロキシ）の設定上、APIリクエストは `/api_kento_yokoyama/customers` というパスのままNode.jsに転送されます。修正前のコードでは `/customers` しか待ち受けていなかったため、URL不一致による「404 Not Found（Unexpected token <）」エラーが発生していました。
これに対応し、プレフィックス付きのURLでも正しくルーティングされるように修正しました。

---

## 3. 結論
以上の修正により、以下の成果が得られました。

1.  **手動作業の削減**: 設定ファイルの書き換え手順（15KM 手順2,3）が完全に不要になりました。
2.  **環境非依存**: 同じソースコード（zipファイル）で、ローカルでもStagingでもそのまま動作します。
3.  **堅牢性向上**: パスや設定の誤りによるトラブルを未然に防ぐ構造になりました。
