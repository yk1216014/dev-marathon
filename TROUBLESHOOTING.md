# トラブルシューティング：Cypressテストとデプロイ環境の不整合

今回のデバッグセッションで発生した問題、原因、および解決策のまとめです。

## 発生していた事象
CypressのE2Eテスト (`kento_yokoyama.cy.js`) において、確認画面での登録ボタン押下後に期待される成功アラートが表示されず（`alertStub never called`）、テストが失敗し続けた。

## 原因と解決の経緯

問題は「テストコード」「デプロイ手順」「ディレクトリ構成」の3つのレイヤーで複合的に発生していました。

### 1. アプリケーション設定の不備 (config.js)
*   **問題**: フロントエンドが参照するAPIのURLが、環境によって正しく解決されていませんでした。
    *   開発者のPC (Localhost) と Cypressのテスト実行環境 (127.0.0.1) の判定ロジックに齟齬があり、APIリクエストが迷子になっていました。
*   **解決**: `config.js` を修正し、環境判定をやめて常に相対パス（`''`）を返すようにシンプル化しました。これにより、どの環境でも確実に同じポートのバックエンドにリクエストが飛ぶようになりました。

### 2. デプロイ手順とディレクトリ構成の不一致
*   **問題**: 修正したファイルをサーバーに反映する際、参照先ディレクトリの認識違いがありました。
    *   `files` は `/app/kento_yokoyama/src/node/web/` に置いていましたが、
    *   Webサーバー (Express) は `/app/kento_yokoyama/src/web/` を参照するように設定されていました。
    *   これにより、いくらファイルを修正しても、Webサーバーは「古いファイル」または「空のファイル」を配信し続けていました。
*   **解決**: 正しいディレクトリ (`src/web`) に修正済みのファイルをコピーし、サーバー設定とファイル配置を一致させました。

### 3. Cypressテストコードの記述ミス（最大の落とし穴）
*   **問題**: ページ遷移後のイベント監視ができていませんでした。
    *   `cy.visit` 直後に `cy.stub(win, 'alert')` を設定していましたが、確認画面への遷移 (`add.html` -> `add-confirm.html`) でページがリロードされ、監視対象の `window` オブジェクトが破棄されていました。
    *   そのため、実際にはアラートが出ていたとしても、Cypressは「古いウィンドウの監視結果」を見て「呼ばれていない」と判定していました。
*   **解決**: ページ遷移が終わった後 (`cy.url().should(...)` の後) に、再度新しい `window` に対して `cy.stub` を設定するようにテストコードを修正しました。

## 教訓

1.  **環境差異の排除**: URL設定などは環境分岐を極力減らし、相対パスなどを活用してシンプルに保つ。
2.  **実体確認の徹底**: 「修正したはず」と思い込まず、サーバー上で `cat` や `ls` を使い、実際に稼働しているファイルの中身と場所を確認する。
3.  **E2Eテストのライフサイクル**: 画面遷移が発生する場合、JavaScriptの実行コンテキスト（windowオブジェクト）が切り替わることを意識し、イベントリスナーやスタブの再設定を行う。

---
**最終成果物**:
*   `src/web/config.js`: 相対パス対応版
*   `test/cypress/test.cy.js` (`kento_yokoyama.cy.js`): ページ遷移対応版
*   サーバー環境: 正しいディレクトリ構成 (`src/web`) へのファイル配置完了
